#CACHE{0}
<INCLURE{fond=inc-head}{title=Article envoyé}>

<BOUCLE_securite(AUTEURS) {tous} {id_auteur=#SESSION{id_auteur}} {billettiste = oui}>
</BOUCLE_securite>

<?php
$newhash = md5(md5($titre) . md5($texte));
if ($titre == '') { $newhash = $hash . 'not'; }
if ($texte == '') { $newhash = $hash . 'not'; }

if ($newhash != $hash) { ?>

<form action="#URL_PAGE{article_envoyer}" method="post">
  <fieldset>
    <legend>Prévisualisation</legend>
    <h1><?=safehtml(typo($titre))?></h1>

    <?=safehtml(propre($texte))?>
  </fieldset>

  <div style="text-align:center;">
    <input name="rubrique" type="hidden" value="6" />
    <input name="hash" type="hidden" value="<?=$newhash?>" />
    <input name="titre" type="hidden" value="<?=htmlentities($titre,ENT_QUOTES,'UTF-8')?>" />
    <input name="texte" type="hidden" value="<?=htmlentities($texte,ENT_QUOTES,'UTF-8')?>" />
    <p><input type="submit" name="form_billet_soumettre" value="Valider" /></p>
  </div>
</form>

<form action="#URL_PAGE{article_envoyer}" method="post">
  <div style="text-align:center;">
    <input name="rubrique" type="hidden" value="6" />
    <input name="hash" type="hidden" value="none" />
    <p><strong>Titre :</strong> <input type="text" name="titre" size="60" value="<?=htmlentities($titre,ENT_QUOTES,'UTF-8')?>" /></p>
    <p><textarea name="texte" cols="75" rows="20"><?=htmlentities($texte,ENT_QUOTES,'UTF-8')?></textarea></p>
    <p><input type="submit" name="form_billet_soumettre" value="Mettre à jour la prévisualisation" /></p>
  </div>
</form>

<?php } else {

  $titre = addslashes(corriger_caracteres($titre));
  $texte = addslashes(corriger_caracteres($texte));
  $rubrique = intval($rubrique);

  $id_auteur = $GLOBALS['auteur_session']['id_auteur'];

  $id_article = spip_abstract_insert("spip_articles",
    "(titre, id_rubrique, texte, statut, accepter_forum, date)",
    "('$titre', $rubrique, '$texte', 'publie', 'abo', NOW())");

  spip_abstract_insert('spip_auteurs_articles', "(id_auteur,id_article)", "($id_auteur,$id_article)");

  @header ("Location: #URL_SITE_SPIP/spip?article$id_article?var_mode=calcul");
} ?>

</B_securite>

<h1>Hors d'ici ! Tu n'es pas billettiste !</h1>

<//B_securite>

<INCLURE{fond=inc-foot}>
